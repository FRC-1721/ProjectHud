<!doctype html>
<html lang="en">



<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
  <style>
    .container {
      display: flex;
    }

    .column {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      margin: 10px;
    }

    body {
      background-color: black;
      color: white;
    }

    .row {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      color: white;
      font-size: 1.2em;
    }

    .critical {
      background-color: red;
      animation: flash 1s infinite;
    }

    @keyframes flash {
      0% {
        background-color: red;
      }

      50% {
        background-color: darkred;
      }

      100% {
        background-color: red;
      }
    }
  </style>
</head>

<body>
  <h1>Dashboard</h1>
  <div class="container" id="dashboard-container">
    {% for project in projects %}
    <div class="column" id="project-{{ project.id }}">
      <h2>{{ project.name }}</h2>
      <h3>Notes</h3>
      <ul id="notes-{{ project.id }}">
        {% for note in project.notes %}
        <li>{{ note.content }}</li>
        {% endfor %}
      </ul>
      <h3>Tasks</h3>
      <ul id="tasks-{{ project.id }}">
        {% for task in project.tasks %}
        <li>{{ task.description }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>
  <script>
    const socket = io();
    var currentGitHash = "";

    socket.on('connect', function () {
      // Request the current Git hash from the server when we connect
      socket.emit('get_git_hash');
    });

    socket.on('message', function (data) {
      console.log(data);
    });

    function updateProject(project_id) {
      socket.emit('update', { project_id: project_id });
    }

    /* Update
     *
     * Run when we get a update
     */
    socket.on('update', function (data) {
      const project_id = data.project_id;
      const notesList = document.getElementById(`notes-${project_id}`);
      const tasksList = document.getElementById(`tasks-${project_id}`);

      notesList.innerHTML = '';
      data.notes.forEach(function (note) {
        const li = document.createElement('li');
        li.textContent = note;
        notesList.appendChild(li);
      });

      tasksList.innerHTML = '';
      data.tasks.forEach(function (task) {
        const li = document.createElement('li');
        li.textContent = task;
        tasksList.appendChild(li);
      });
    });

    /* Project updated
     *
     * Run when we get a project_updated
     */
    socket.on('project_updated', function (data) {
      // Code to update the dashboard
      fetchProjects();
    });

    function fetchProjects() {
      fetch('/api/projects')
        .then(response => response.json())
        .then(data => {
          // Code to update the dashboard with new project data
          updateDashboard(data);
        });
    }

    function updateDashboard(projects) {
      // Clear and re-render the dashboard with the updated projects
    }

    /* Check if git hash has changed!
     *
     */
    socket.on('git_hash', function (data) {
      if (currentGitHash == "") {
        currentGitHash = data["git_hash"];
      };

      console.log("comparing hash %s with %s", currentGitHash, data["git_hash"]);

      if (currentGitHash !== data["git_hash"]) {
        // Refresh the page if hashes don't match
        location.reload();
      }
    });

    // Optionally, poll for updates every X seconds
    setInterval(() => {
      document.querySelectorAll('.column').forEach(col => {
        const project_id = col.id.split('-')[1];
        updateProject(project_id);
      });
    }, 5);  // Adjust the interval as needed


    // Second script for colors
    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function updateDashboard(projects) {
      var container = document.getElementById('dashboard-container');
      container.innerHTML = '';

      projects.forEach(function (project) {
        var row = document.createElement('div');
        row.className = 'row';
        row.style.backgroundColor = getRandomColor();

        if (project.critical) {
          row.classList.add('critical');
        }

        row.innerText = project.name;
        container.appendChild(row);
      });
    }
  </script>

</body>

</html>